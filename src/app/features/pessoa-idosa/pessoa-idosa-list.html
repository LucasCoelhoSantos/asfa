<app-main-menu></app-main-menu>

<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h2 mb-1 text-primary">Pessoas Idosas Cadastradas</h1>
          <p class="text-muted mb-0">Gerencie as pessoas idosas cadastradas no sistema</p>
        </div>
        <button class="btn btn-primary" (click)="navigate('/pessoa-idosa/novo')">
          <i class="bi bi-plus-circle me-2"></i>
          Adicionar Pessoa
        </button>
      </div>

      <!-- Filtros -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="bi bi-funnel me-2"></i>
            Filtros de Pesquisa
          </h5>
        </div>
        <div class="card-body">
          <!-- Filtros Básicos -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3">Informações Básicas</h6>
            </div>
            <div class="col-md-3">
              <label class="form-label">Nome</label>
              <input 
                type="text" 
                class="form-control" 
                placeholder="Nome" 
                (input)="setFiltroNome(getValue($event))" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Data Nasc.</label>
              <input 
                type="date" 
                class="form-control" 
                (input)="setFiltroDataNascimento(getValue($event))" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Estado Civil</label>
              <select class="form-select" (change)="setFiltroEstadoCivil(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let ec of estadosCivis" [value]="ec">{{ ec }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">CPF</label>
              <input 
                type="text" 
                class="form-control" 
                placeholder="000.000.000-00" 
                appMask="cpf" 
                (input)="setFiltroCpf(getValue($event))" />
            </div>
            <div class="col-md-3">
              <label class="form-label">RG</label>
              <input 
                type="text" 
                class="form-control" 
                placeholder="00.000.000-0" 
                appMask="rg" 
                (input)="setFiltroRg(getValue($event))" />
            </div>
            <div class="col-md-3">
              <label class="form-label">CEP</label>
              <input 
                type="text" 
                class="form-control" 
                placeholder="00000-000" 
                appMask="cep" 
                (input)="setFiltroCep(getValue($event))" />
            </div>
          </div>

          <!-- Filtros Avançados -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3">Informações Adicionais</h6>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  (change)="setFiltroAlfabetizado(getChecked($event))" />
                <label class="form-check-label">Alfabetizado</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  (change)="setFiltroEstudaAtualmente(getChecked($event))" />
                <label class="form-check-label">Estuda Atualmente</label>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Nível/Série Atual</label>
              <select class="form-select" (change)="setFiltroNivelSerie(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let nivel of niveisSerie" [value]="nivel">{{ nivel }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Curso Técnico/Formação</label>
              <select class="form-select" (change)="setFiltroCursoFormacao(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let curso of cursosFormacao" [value]="curso">{{ curso }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Benefício</label>
              <select class="form-select" (change)="setFiltroBeneficio(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let beneficio of beneficios" [value]="beneficio">{{ beneficio }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Situação Ocupacional</label>
              <select class="form-select" (change)="setFiltroSituacaoOcupacional(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let situacao of situacoesOcupacionais" [value]="situacao">{{ situacao }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Problema de Saúde</label>
              <select class="form-select" (change)="setFiltroProblemaDeSaude(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let problema of problemasSaude" [value]="problema">{{ problema }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Aposentado</label>
              <select class="form-select" (change)="setFiltroAposentado(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let aposentado of aposentados" [value]="aposentado">{{ aposentado }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Moradia</label>
              <select class="form-select" (change)="setFiltroMoradia(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let moradia of moradias" [value]="moradia">{{ moradia }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Deficiência</label>
              <select class="form-select" (change)="setFiltroDeficiencia(getValue($event))">
                <option value="">Todos</option>
                <option *ngFor="let deficiencia of deficiencias" [value]="deficiencia">{{ deficiencia }}</option>
              </select>
            </div>
          </div>

          <!-- Controles -->
          <div class="row g-3">
            <div class="col-12">
              <h6 class="text-primary mb-3">Controles</h6>
            </div>
            <div class="col-md-2">
              <label class="form-label">Status</label>
              <select class="form-select" (change)="setFiltroAtivo(getValue($event))">
                <option value="">Todos</option>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Itens por Página</label>
              <select class="form-select" (change)="setPageSize(+getValue($event))">
                <option *ngFor="let size of pageSizeOptions" [value]="size">
                  {{ size === -1 ? 'Todos' : size }}
                </option>
              </select>
            </div>
            <div class="col-md-8 d-flex align-items-end gap-2">
              <button (click)="buscar()" class="btn btn-primary">
                <i class="bi bi-search me-2"></i>
                Buscar
              </button>
              <button (click)="limparFiltros()" class="btn btn-outline-secondary">
                <i class="bi bi-trash me-2"></i>
                Limpar Filtros
              </button>
              <button (click)="exportarPdf()" class="btn btn-success">
                <i class="bi bi-file-pdf me-2"></i>
                Exportar PDF
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <ng-container *ngIf="loading$ | async; else content">
        <app-table-skeleton [rows]="5"></app-table-skeleton>
      </ng-container>

      <!-- Content -->
      <ng-template #content>
        <ng-container *ngIf="pessoas$ | async as resultado">
          <!-- Tabela usando o novo componente -->
          <app-data-table
            [columns]="tableColumns"
            [data]="resultado.pessoas"
            [actions]="tableActions"
            [emptyMessage]="'Nenhuma pessoa idosa cadastrada'"
            [emptySubMessage]="'Clique no botão acima para adicionar uma nova pessoa'"
            (actionClick)="onTableAction($event)">
          </app-data-table>

          <!-- Paginação -->
          <div class="d-flex justify-content-between align-items-center mt-4" *ngIf="resultado.pessoas.length > 0">
            <div class="text-muted">
                             Mostrando {{ (pageIndex * pageSize) + 1 }} a {{ math.min((pageIndex + 1) * pageSize, resultado.total) }} de {{ resultado.total }} registros
            </div>
            <nav *ngIf="pageSize > 0 && resultado.total > pageSize">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item" [class.disabled]="pageIndex === 0">
                  <button class="page-link" (click)="setPageIndex(pageIndex - 1)" [disabled]="pageIndex === 0">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                </li>
                <li class="page-item">
                  <span class="page-link">
                                         Página {{ pageIndex + 1 }} de {{ math.ceil(resultado.total / pageSize) }}
                  </span>
                </li>
                <li class="page-item" [class.disabled]="!resultado.hasMore">
                  <button class="page-link" (click)="setPageIndex(pageIndex + 1)" [disabled]="!resultado.hasMore">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </ng-container>
      </ng-template>
    </div>
  </div>
</div>